data StateType 		
  = I  
  | O 
  | A
  | B 
    deriving (Eq, Show)

data StateType 
  = ItemAvailable  
  | OfferPlaced 
  | Accepted 
    deriving (Eq, Show)

template Market
  with 
    owner       : Party
    buyer       : Party
    state       : StateType

  where
    signatory owner 
    ensure owner /= buyer  
    observer buyer

    nonconsuming choice Reject : ItemId
      with
        descriptionParam : Text
        askingPriceParam : Int
        ownerParam       : Party
      controller owner
        do
          assertMsg "Item is not available for an offer." this.state == O

          create Market with
            state  = I

    choice MakeOffer : (MarketId, OfferId)
      with
        item                 : ItemId
        observerSellerParam  : Party
        offerPriceParam      : Int
        buyerParam           : Party 
      controller buyer
        do 
          assertMsg "Item is not available for an offer." (this.state == I)
          
          
          market <- create this with
            state = O
            
    choice MakeOffer : (MarketId, OfferId)
      with
        item                 : ItemId
        observerSellerParam  : Party
        offerPriceParam      : Int
        buyerParam           : Party 
      controller buyer
        do 
          assertMsg "Item is not available for an offer." (this.state == O)
          
          
          market <- create this with
            state = A
            
   choice Further : (MarketId, OfferId)
      with
        item                 : ItemId
        observerSellerParam  : Party
        offerPriceParam      : Int
        buyerParam           : Party 
      controller buyer
        do 
          assertMsg "Item is not available for an offer." (this.state == A)
          
          
          market <- create this with
            state = B
   choice Once : (MarketId, OfferId)
      with
        item                 : ItemId
        observerSellerParam  : Party
        offerPriceParam      : Int
        buyerParam           : Party 
      controller buyer
        do 
          assertMsg "Item is not available for an offer." (this.state == B)
          
          
          market <- create this with
            state = I
